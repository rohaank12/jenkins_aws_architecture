pipeline {
    agent any

    environment {
        JENKINS_HOME_PATH = '/var/lib/jenkins'
        BACKUP_SCRIPT_PATH = './jenkins_backup.sh'
    }

    stages {
        stage('Prepare Backup Script') {
            steps {
                script {
                    sh "chmod +x ${BACKUP_SCRIPT_PATH}"
                }
            }
        }

        stage('Run Jenkins Backup') {
            steps {
                # Use withCredentials for secure AWS secrets (if not using IAM roles)
                withCredentials([
                    awsAccessKeyId('your-aws-access-key-id-credential-id'),
                    awsSecretKey('your-aws-secret-access-key-credential-id')
                ]) {
                    sh(script: """
                        sudo ${BACKUP_SCRIPT_PATH} \
                            ${JENKINS_HOME_PATH} \
                            "${AWS_ACCESS_KEY_ID}" \
                            "${AWS_SECRET_ACCESS_KEY}"
                    """,
                    # --- ADD THIS LINE BELOW ---
                    readTimeout: 1200 # Set timeout to 1200 seconds (20 minutes). Adjust as needed.
                    )
                }
            }
        }
    }

    post {
        always {
            echo "Backup pipeline finished."
        }
    }
}
